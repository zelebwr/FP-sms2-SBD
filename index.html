<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Javva E-commerce</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation Bar -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold">Javva Shop</h1>
            <div class="flex items-center space-x-4">
                <button id="home-btn" class="hover:text-blue-200"><i class="fas fa-home mr-1"></i> Home</button>
                <button id="products-btn" class="hover:text-blue-200"><i class="fas fa-shopping-bag mr-1"></i> Products</button>
                <button id="wishlist-btn" class="hover:text-blue-200"><i class="fas fa-heart mr-1"></i> Wishlist</button>
                <button id="cart-btn" class="hover:text-blue-200 relative">
                    <i class="fas fa-shopping-cart mr-1"></i> Cart
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                </button>
                <button id="orders-btn" class="hover:text-blue-200"><i class="fas fa-box mr-1"></i> Orders</button>
                <button id="profile-btn" class="hover:text-blue-200"><i class="fas fa-user mr-1"></i> Profile</button>
                <button id="auth-btn" class="bg-white text-blue-600 px-4 py-1 rounded hover:bg-blue-100">Login</button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="container mx-auto px-4 py-8">
        <!-- Auth Section -->
        <div id="auth-section" class="hidden">
            <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md">
                <div class="flex justify-between mb-6">
                    <button id="login-tab" class="w-1/2 py-2 font-semibold text-center border-b-2 border-blue-500">Login</button>
                    <button id="register-tab" class="w-1/2 py-2 font-semibold text-center text-gray-500">Register</button>
                </div>
                
                <!-- Login Form -->
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-gray-700">Email</label>
                        <input type="email" id="login-email" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-gray-700">Password</label>
                        <input type="password" id="login-password" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">Login</button>
                </form>
                
                <!-- Register Form -->
                <form id="register-form" class="space-y-4 hidden">
                    <div>
                        <label class="block text-gray-700">Name</label>
                        <input type="text" id="register-name" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-gray-700">Email</label>
                        <input type="email" id="register-email" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-gray-700">Password</label>
                        <input type="password" id="register-password" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-gray-700">Phone (optional)</label>
                        <input type="tel" id="register-phone" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700">Address (optional)</label>
                        <textarea id="register-address" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">Register</button>
                </form>
            </div>
        </div>

        <!-- Home Section -->
        <div id="home-section" class="block">
            <div class="flex flex-col items-center justify-center h-96">
                <h2 class="text-4xl font-bold text-blue-600 mb-6">Welcome to Javva Shop</h2>
                <p class="text-xl text-gray-600 mb-8">Your one-stop destination for all your shopping needs</p>
                <button id="browse-products" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition">
                    Browse Products
                </button>
            </div>
        </div>

        <!-- Products Section -->
        <div id="products-section" class="hidden">
            <h2 class="text-2xl font-bold mb-6">Our Products</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="products-container">
                <!-- Products will be loaded here -->
                <div class="animate-pulse bg-white p-4 rounded-lg shadow">
                    <div class="h-48 bg-gray-200 rounded mb-4"></div>
                    <div class="h-6 bg-gray-200 rounded mb-2"></div>
                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
                    <div class="h-8 bg-gray-200 rounded"></div>
                </div>
                <div class="animate-pulse bg-white p-4 rounded-lg shadow">
                    <div class="h-48 bg-gray-200 rounded mb-4"></div>
                    <div class="h-6 bg-gray-200 rounded mb-2"></div>
                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
                    <div class="h-8 bg-gray-200 rounded"></div>
                </div>
                <div class="animate-pulse bg-white p-4 rounded-lg shadow">
                    <div class="h-48 bg-gray-200 rounded mb-4"></div>
                    <div class="h-6 bg-gray-200 rounded mb-2"></div>
                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
                    <div class="h-8 bg-gray-200 rounded"></div>
                </div>
                <div class="animate-pulse bg-white p-4 rounded-lg shadow">
                    <div class="h-48 bg-gray-200 rounded mb-4"></div>
                    <div class="h-6 bg-gray-200 rounded mb-2"></div>
                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
                    <div class="h-8 bg-gray-200 rounded"></div>
                </div>
            </div>
        </div>

        <!-- Product Detail Section -->
        <div id="product-detail-section" class="hidden">
            <button id="back-to-products" class="text-blue-600 mb-4 flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Back to Products
            </button>
            <div id="product-detail" class="bg-white p-6 rounded-lg shadow-md">
                <!-- Product detail will be loaded here -->
            </div>
        </div>

        <!-- Cart Section -->
        <div id="cart-section" class="hidden">
            <h2 class="text-2xl font-bold mb-6">Your Shopping Cart</h2>
            <div id="cart-items" class="space-y-4">
                <!-- Cart items will be loaded here -->
                <p id="empty-cart-message" class="text-gray-500 text-center py-8">Your cart is empty.</p>
            </div>
            <div class="mt-8 bg-white p-4 rounded-lg shadow">
                <div class="flex justify-between mb-2">
                    <span class="font-semibold">Subtotal:</span>
                    <span id="cart-subtotal">$0.00</span>
                </div>
                <button id="checkout-btn" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition mt-4">
                    Proceed to Checkout
                </button>
            </div>
        </div>

        <!-- Checkout Section -->
        <div id="checkout-section" class="hidden">
            <h2 class="text-2xl font-bold mb-6">Checkout</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4">Shipping Information</h3>
                    <form id="checkout-form" class="space-y-4">
                        <div>
                            <label class="block text-gray-700">Full Name</label>
                            <input type="text" id="checkout-name" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-gray-700">Email</label>
                            <input type="email" id="checkout-email" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-gray-700">Phone Number</label>
                            <input type="tel" id="checkout-phone" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-gray-700">Shipping Address</label>
                            <textarea id="checkout-address" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" required></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700">Payment Method</label>
                            <select id="checkout-payment" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Select payment method</option>
                                <option value="credit_card">Credit Card</option>
                                <option value="paypal">PayPal</option>
                                <option value="bank_transfer">Bank Transfer</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">
                            Place Order
                        </button>
                    </form>
                </div>
                <div>
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <h3 class="text-lg font-semibold mb-4">Order Summary</h3>
                        <div id="checkout-items" class="space-y-3 mb-4">
                            <!-- Checkout items will be loaded here -->
                        </div>
                        <hr class="my-4">
                        <div class="flex justify-between font-semibold">
                            <span>Total:</span>
                            <span id="checkout-total">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Section -->
        <div id="orders-section" class="hidden">
            <h2 class="text-2xl font-bold mb-6">Your Orders</h2>
            <div id="orders-container" class="space-y-6">
                <!-- Orders will be loaded here -->
                <p id="empty-orders-message" class="text-gray-500 text-center py-8">You haven't placed any orders yet.</p>
            </div>
        </div>

        <!-- Order Detail Section -->
        <div id="order-detail-section" class="hidden">
            <button id="back-to-orders" class="text-blue-600 mb-4 flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Back to Orders
            </button>
            <div id="order-detail" class="bg-white p-6 rounded-lg shadow-md">
                <!-- Order detail will be loaded here -->
            </div>
        </div>

        <!-- Wishlist Section -->
        <div id="wishlist-section" class="hidden">
            <h2 class="text-2xl font-bold mb-6">Your Wishlist</h2>
            <div id="wishlist-items" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Wishlist items will be loaded here -->
                <p id="empty-wishlist-message" class="text-gray-500 text-center py-8 col-span-full">Your wishlist is empty.</p>
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profile-section" class="hidden">
            <h2 class="text-2xl font-bold mb-6">Your Profile</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4">Personal Information</h3>
                    <form id="profile-form" class="space-y-4">
                        <div>
                            <label class="block text-gray-700">Full Name</label>
                            <input type="text" id="profile-name" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-gray-700">Email</label>
                            <input type="email" id="profile-email" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-gray-700">Phone Number</label>
                            <input type="tel" id="profile-phone" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-gray-700">Address</label>
                            <textarea id="profile-address" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">
                            Update Profile
                        </button>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4">Change Password</h3>
                    <form id="password-form" class="space-y-4">
                        <div>
                            <label class="block text-gray-700">Current Password</label>
                            <input type="password" id="current-password" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-gray-700">New Password</label>
                            <input type="password" id="new-password" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-gray-700">Confirm New Password</label>
                            <input type="password" id="confirm-password" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">
                            Change Password
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Notification Toast -->
        <div id="toast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 translate-y-[-100px]">
            <p id="toast-message"></p>
        </div>
    </div>

    <script>
        // API Base URL from .env
        const API_URL = 'http://localhost:8080/api';

        // State Management
        let currentUser = null;
        let token = localStorage.getItem('token');
        let cart = [];
        let products = [];
        let orders = [];
        let wishlist = [];
        
        // DOM Elements
        const sections = [
            'home-section', 'auth-section', 'products-section', 'product-detail-section',
            'cart-section', 'checkout-section', 'orders-section', 'order-detail-section',
            'wishlist-section', 'profile-section'
        ];

        // Helper Functions
        function showSection(sectionId) {
            sections.forEach(section => {
                document.getElementById(section).classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300`;
            toast.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
            toast.classList.add('text-white');
            
            toastMessage.textContent = message;
            
            // Show the toast
            setTimeout(() => {
                toast.style.transform = 'translateY(0)';
            }, 100);
            
            // Hide after 3 seconds
            setTimeout(() => {
                toast.style.transform = 'translateY(-100px)';
            }, 3000);
        }

        async function makeRequest(endpoint, method = 'GET', data = null) {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            try {
                const response = await fetch(`${API_URL}${endpoint}`, {
                    method,
                    headers,
                    body: data ? JSON.stringify(data) : null
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || 'Something went wrong');
                }
                
                return result;
            } catch (error) {
                console.error('API Error:', error);
                showToast(error.message, 'error');
                throw error;
            }
        }

        // Authentication
        async function login(email, password) {
            try {
                const data = await makeRequest('/auth/login', 'POST', { email, password });
                token = data.token;
                currentUser = data.user;
                localStorage.setItem('token', token);
                updateAuthUI();
                loadUserData();
                showSection('home-section');
                showToast('Login successful!');
            } catch (error) {
                showToast('Login failed: ' + error.message, 'error');
            }
        }

        async function register(userData) {
            try {
                await makeRequest('/auth/register', 'POST', userData);
                showToast('Registration successful! Please login.');
                document.getElementById('login-tab').click();
            } catch (error) {
                showToast('Registration failed: ' + error.message, 'error');
            }
        }

        function logout() {
            token = null;
            currentUser = null;
            localStorage.removeItem('token');
            updateAuthUI();
            showSection('home-section');
            showToast('Logged out successfully');
        }

        function updateAuthUI() {
            const authBtn = document.getElementById('auth-btn');
            const profileBtn = document.getElementById('profile-btn');
            const ordersBtn = document.getElementById('orders-btn');
            const wishlistBtn = document.getElementById('wishlist-btn');
            
            if (token) {
                authBtn.textContent = 'Logout';
                profileBtn.classList.remove('hidden');
                ordersBtn.classList.remove('hidden');
                wishlistBtn.classList.remove('hidden');
            } else {
                authBtn.textContent = 'Login';
                profileBtn.classList.add('hidden');
                ordersBtn.classList.add('hidden');
                wishlistBtn.classList.add('hidden');
            }
        }

        // Products
        async function loadProducts() {
            try {
                const data = await makeRequest('/products');
                products = data.products;
                renderProducts();
            } catch (error) {
                showToast('Failed to load products', 'error');
            }
        }

        function renderProducts() {
            const container = document.getElementById('products-container');
            container.innerHTML = '';
            
            if (products.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-full">No products available.</p>';
                return;
            }
            
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'bg-white rounded-lg shadow overflow-hidden';
                productCard.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <h3 class="text-lg font-semibold mb-2">${product.name}</h3>
                        <p class="text-gray-600 mb-2">${product.description.substring(0, 60)}${product.description.length > 60 ? '...' : ''}</p>
                        <div class="flex justify-between items-center mt-4">
                            <span class="text-lg font-bold">$${product.price.toFixed(2)}</span>
                            <button class="bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 transition view-product" data-id="${product.id}">
                                View Details
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(productCard);
                
                // Add event listener to view product button
                productCard.querySelector('.view-product').addEventListener('click', () => {
                    showProductDetail(product.id);
                });
            });
        }

        async function showProductDetail(productId) {
            try {
                const product = products.find(p => p.id === productId) || 
                               await makeRequest(`/products/${productId}`);
                
                const detailContainer = document.getElementById('product-detail');
                detailContainer.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <img src="${product.image}" alt="${product.name}" class="w-full h-auto rounded-lg">
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold mb-2">${product.name}</h2>
                            <p class="text-xl font-semibold text-blue-600 mb-4">$${product.price.toFixed(2)}</p>
                            <div class="mb-6">
                                <p class="text-gray-700">${product.description}</p>
                            </div>
                            <div class="flex items-center mb-6">
                                <label for="quantity" class="mr-4">Quantity:</label>
                                <input type="number" id="quantity" min="1" value="1" class="w-16 px-2 py-1 border rounded-md">
                            </div>
                            <div class="flex space-x-4">
                                <button id="add-to-cart" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition flex-1">
                                    Add to Cart
                                </button>
                                <button id="add-to-wishlist" class="bg-white border border-blue-600 text-blue-600 px-4 py-2 rounded-md hover:bg-blue-50 transition">
                                    <i class="far fa-heart"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                showSection('product-detail-section');
                
                // Add event listeners
                document.getElementById('add-to-cart').addEventListener('click', () => {
                    const quantity = parseInt(document.getElementById('quantity').value);
                    addToCart(product, quantity);
                });
                
                document.getElementById('add-to-wishlist').addEventListener('click', () => {
                    addToWishlist(product.id);
                });
            } catch (error) {
                showToast('Failed to load product details', 'error');
            }
        }

        // Cart
        async function loadCart() {
            if (!token) return;
            
            try {
                const data = await makeRequest('/cart');
                cart = data.items || [];
                updateCartCount();
                renderCart();
            } catch (error) {
                console.error('Failed to load cart:', error);
            }
        }

        async function addToCart(product, quantity) {
            if (!token) {
                showToast('Please login to add items to cart', 'error');
                showSection('auth-section');
                return;
            }
            
            try {
                await makeRequest('/cart/add', 'POST', { 
                    productId: product.id, 
                    quantity 
                });
                
                showToast(`${product.name} added to cart!`);
                loadCart();
            } catch (error) {
                showToast('Failed to add item to cart', 'error');
            }
        }

        async function updateCartItem(itemId, quantity) {
            try {
                await makeRequest(`/cart/${itemId}`, 'PUT', { quantity });
                loadCart();
            } catch (error) {
                showToast('Failed to update cart item', 'error');
            }
        }

        async function removeCartItem(itemId) {
            try {
                await makeRequest(`/cart/${itemId}`, 'DELETE');
                loadCart();
                showToast('Item removed from cart');
            } catch (error) {
                showToast('Failed to remove item from cart', 'error');
            }
        }

        function updateCartCount() {
            const cartCount = document.getElementById('cart-count');
            let totalItems = 0;
            
            if (cart.length) {
                totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            }
            
            cartCount.textContent = totalItems;
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            const emptyMessage = document.getElementById('empty-cart-message');
            const subtotalElement = document.getElementById('cart-subtotal');
            
            container.innerHTML = '';
            
            if (cart.length === 0) {
                emptyMessage.classList.remove('hidden');
                subtotalElement.textContent = '$0.00';
                return;
            }
            
            emptyMessage.classList.add('hidden');
            let subtotal = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'flex items-center bg-white p-4 rounded-lg shadow';
                cartItem.innerHTML = `
                    <img src="${item.image || 'https://via.placeholder.com/80'}" alt="${item.name}" class="w-20 h-20 object-cover rounded mr-4">
                    <div class="flex-1">
                        <h3 class="font-semibold">${item.name}</h3>
                        <p class="text-gray-600">$${item.price.toFixed(2)} × ${item.quantity}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="decrement-item text-gray-500 hover:text-gray-700" data-id="${item.id}">
                            <i class="fas fa-minus-circle"></i>
                        </button>
                        <span>${item.quantity}</span>
                        <button class="increment-item text-gray-500 hover:text-gray-700" data-id="${item.id}">
                            <i class="fas fa-plus-circle"></i>
                        </button>
                        <button class="remove-item ml-4 text-red-500 hover:text-red-700" data-id="${item.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(cartItem);
                
                // Add event listeners
                cartItem.querySelector('.decrement-item').addEventListener('click', () => {
                    if (item.quantity > 1) {
                        updateCartItem(item.id, item.quantity - 1);
                    }
                });
                
                cartItem.querySelector('.increment-item').addEventListener('click', () => {
                    updateCartItem(item.id, item.quantity + 1);
                });
                
                cartItem.querySelector('.remove-item').addEventListener('click', () => {
                    removeCartItem(item.id);
                });
            });
            
            subtotalElement.textContent = `$${subtotal.toFixed(2)}`;
            
            // Also update checkout summary if it's visible
            const checkoutContainer = document.getElementById('checkout-items');
            const checkoutTotal = document.getElementById('checkout-total');
            
            if (checkoutContainer) {
                checkoutContainer.innerHTML = '';
                
                cart.forEach(item => {
                    const checkoutItem = document.createElement('div');
                    checkoutItem.className = 'flex justify-between';
                    checkoutItem.innerHTML = `
                        <span>${item.name} × ${item.quantity}</span>
                        <span>$${(item.price * item.quantity).toFixed(2)}</span>
                    `;
                    checkoutContainer.appendChild(checkoutItem);
                });
                
                checkoutTotal.textContent = `$${subtotal.toFixed(2)}`;
            }
        }

        // Orders
        async function loadOrders() {
            if (!token) return;
            
            try {
                const data = await makeRequest('/orders');
                orders = data.orders || [];
                renderOrders();
            } catch (error) {
                console.error('Failed to load orders:', error);
            }
        }

        function renderOrders() {
            const container = document.getElementById('orders-container');
            const emptyMessage = document.getElementById('empty-orders-message');
            
            container.innerHTML = '';
            
            if (orders.length === 0) {
                emptyMessage.classList.remove('hidden');
                return;
            }
            
            emptyMessage.classList.add('hidden');
            
            orders.forEach(order => {
                const orderDate = new Date(order.createdAt).toLocaleDateString();
                
                const orderCard = document.createElement('div');
                orderCard.className = 'bg-white rounded-lg shadow p-6';
                orderCard.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="font-semibold">Order #${order.id}</h3>
                            <p class="text-gray-600">${orderDate}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-sm font-semibold
                            ${order.status === 'completed' ? 'bg-green-100 text-green-800' : ''}
                            ${order.status === 'processing' ? 'bg-blue-100 text-blue-800' : ''}
                            ${order.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : ''}
                            ${order.status === 'cancelled' ? 'bg-red-100 text-red-800' : ''}
                        ">
                            ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}
                        </span>
                    </div>
                    <div class="border-t border-gray-200 pt-4">
                        <p class="text-gray-600 mb-2">${order.items.length} item(s)</p>
                        <p class="font-semibold">Total: $${order.totalAmount.toFixed(2)}</p>
                    </div>
                    <button class="view-order mt-4 text-blue-600 hover:text-blue-800" data-id="${order.id}">
                        View Details
                    </button>
                `;
                
                container.appendChild(orderCard);
                
                // Add event listener
                orderCard.querySelector('.view-order').addEventListener('click', () => {
                    showOrderDetail(order.id);
                });
            });
        }

        async function showOrderDetail(orderId) {
            try {
                const order = orders.find(o => o.id === orderId) || 
                             await makeRequest(`/orders/${orderId}`);
                
                const detailContainer = document.getElementById('order-detail');
                const orderDate = new Date(order.createdAt).toLocaleDateString();
                
                detailContainer.innerHTML = `
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold mb-2">Order #${order.id}</h2>
                        <div class="flex items-center mb-4">
                            <span class="px-3 py-1 rounded-full text-sm font-semibold mr-2
                                ${order.status === 'completed' ? 'bg-green-100 text-green-800' : ''}
                                ${order.status === 'processing' ? 'bg-blue-100 text-blue-800' : ''}
                                ${order.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : ''}
                                ${order.status === 'cancelled' ? 'bg-red-100 text-red-800' : ''}
                            ">
                                ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}
                            </span>
                            <span class="text-gray-600">Placed on ${orderDate}</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
                        <div>
                            <h3 class="font-semibold mb-3">Shipping Information</h3>
                            <p>${order.shippingAddress.name}</p>
                            <p>${order.shippingAddress.address}</p>
                            <p>${order.shippingAddress.phone}</p>
                            <p>${order.shippingAddress.email}</p>
                        </div>
                        <div>
                            <h3 class="font-semibold mb-3">Payment Information</h3>
                            <p>Method: ${order.paymentMethod}</p>
                            <p>Status: ${order.paymentStatus}</p>
                        </div>
                    </div>
                    
                    <h3 class="font-semibold mb-3">Order Items</h3>
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="space-y-4">
                            ${order.items.map(item => `
                                <div class="flex items-center border-b border-gray-200 pb-4 last:border-0 last:pb-0">
                                    <img src="${item.image || 'https://via.placeholder.com/60'}" alt="${item.name}" class="w-16 h-16 object-cover rounded mr-4">
                                    <div class="flex-1">
                                        <h4 class="font-semibold">${item.name}</h4>
                                        <p class="text-gray-600">$${item.price.toFixed(2)} × ${item.quantity}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold">$${(item.price * item.quantity).toFixed(2)}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex justify-between mb-2">
                            <span>Subtotal:</span>
                            <span>$${order.totalAmount.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span>Shipping:</span>
                            <span>$0.00</span>
                        </div>
                        <div class="flex justify-between font-semibold text-lg border-t border-gray-200 pt-2 mt-2">
                            <span>Total:</span>
                            <span>$${order.totalAmount.toFixed(2)}</span>
                        </div>
                    </div>
                `;
                
                showSection('order-detail-section');
            } catch (error) {
                showToast('Failed to load order details', 'error');
            }
        }

        // Checkout
        async function placeOrder(orderData) {
            try {
                await makeRequest('/orders', 'POST', orderData);
                cart = [];
                updateCartCount();
                showToast('Order placed successfully!');
                loadOrders();
                showSection('orders-section');
            } catch (error) {
                showToast('Failed to place order', 'error');
            }
        }

        // Wishlist
        async function loadWishlist() {
            if (!token) return;
            
            try {
                const data = await makeRequest('/wishlist');
                wishlist = data.items || [];
                renderWishlist();
            } catch (error) {
                console.error('Failed to load wishlist:', error);
            }
        }

        async function addToWishlist(productId) {
            if (!token) {
                showToast('Please login to add items to wishlist', 'error');
                showSection('auth-section');
                return;
            }
            
            try {
                await makeRequest('/wishlist/add', 'POST', { productId });
                showToast('Item added to wishlist!');
                loadWishlist();
            } catch (error) {
                showToast('Failed to add item to wishlist', 'error');
            }
        }

        async function removeFromWishlist(productId) {
            try {
                await makeRequest(`/wishlist/${productId}`, 'DELETE');
                loadWishlist();
                showToast('Item removed from wishlist');
            } catch (error) {
                showToast('Failed to remove item from wishlist', 'error');
            }
        }

        function renderWishlist() {
            const container = document.getElementById('wishlist-items');
            const emptyMessage = document.getElementById('empty-wishlist-message');
            
            container.innerHTML = '';
            
            if (wishlist.length === 0) {
                emptyMessage.classList.remove('hidden');
                return;
            }
            
            emptyMessage.classList.add('hidden');
            
            wishlist.forEach(item => {
                const wishlistItem = document.createElement('div');
                wishlistItem.className = 'bg-white rounded-lg shadow overflow-hidden';
                wishlistItem.innerHTML = `
                    <img src="${item.image || 'https://via.placeholder.com/300'}" alt="${item.name}" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <h3 class="text-lg font-semibold mb-2">${item.name}</h3>
                        <p class="text-gray-600 mb-2">${item.description.substring(0, 60)}${item.description.length > 60 ? '...' : ''}</p>
                        <div class="flex justify-between items-center mt-4">
                            <span class="text-lg font-bold">$${item.price.toFixed(2)}</span>
                            <div class="space-x-2">
                                <button class="bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 transition add-to-cart-wishlist" data-id="${item.id}">
                                    Add to Cart
                                </button>
                                <button class="text-red-500 hover:text-red-700 remove-wishlist" data-id="${item.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(wishlistItem);
                
                // Add event listeners
                wishlistItem.querySelector('.add-to-cart-wishlist').addEventListener('click', () => {
                    addToCart(item, 1);
                });
                
                wishlistItem.querySelector('.remove-wishlist').addEventListener('click', () => {
                    removeFromWishlist(item.id);
                });
            });
        }

        // Profile
        async function loadUserProfile() {
            if (!token) return;
            
            try {
                const data = await makeRequest('/users/profile');
                currentUser = data.user;
                
                // Populate profile form
                document.getElementById('profile-name').value = currentUser.name || '';
                document.getElementById('profile-email').value = currentUser.email || '';
                document.getElementById('profile-phone').value = currentUser.phone || '';
                document.getElementById('profile-address').value = currentUser.address || '';
            } catch (error) {
                console.error('Failed to load user profile:', error);
            }
        }

        async function updateProfile(profileData) {
            try {
                const data = await makeRequest('/users/profile', 'PUT', profileData);
                currentUser = data.user;
                showToast('Profile updated successfully');
            } catch (error) {
                showToast('Failed to update profile', 'error');
            }
        }

        async function updatePassword(passwordData) {
            try {
                await makeRequest('/users/password', 'PUT', passwordData);
                showToast('Password updated successfully');
                
                // Clear form
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            } catch (error) {
                showToast('Failed to update password', 'error');
            }
        }

        // Initialize app
        function initApp() {
            // Check if user is logged in
            if (token) {
                try {
                    // Verify token and load user data
                    loadUserData();
                } catch (error) {
                    console.error('Invalid token:', error);
                    logout();
                }
            }
            
            updateAuthUI();
            loadProducts();
            
            // Set up event listeners
            document.getElementById('home-btn').addEventListener('click', () => showSection('home-section'));
            document.getElementById('products-btn').addEventListener('click', () => {
                showSection('products-section');
                loadProducts();
            });
            document.getElementById('cart-btn').addEventListener('click', () => {
                showSection('cart-section');
                loadCart();
            });
            document.getElementById('wishlist-btn').addEventListener('click', () => {
                if (!token) {
                    showToast('Please login to view your wishlist', 'error');
                    showSection('auth-section');
                    return;
                }
                showSection('wishlist-section');
                loadWishlist();
            });
            document.getElementById('orders-btn').addEventListener('click', () => {
                if (!token) {
                    showToast('Please login to view your orders', 'error');
                    showSection('auth-section');
                    return;
                }
                showSection('orders-section');
                loadOrders();
            });
            document.getElementById('profile-btn').addEventListener('click', () => {
                if (!token) {
                    showToast('Please login to view your profile', 'error');
                    showSection('auth-section');
                    return;
                }
                showSection('profile-section');
                loadUserProfile();
            });
            document.getElementById('auth-btn').addEventListener('click', () => {
                if (token) {
                    logout();
                } else {
                    showSection('auth-section');
                }
            });
            document.getElementById('login-tab').addEventListener('click', () => {
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('login-tab').classList.add('border-blue-500', 'text-blue-700');
                document.getElementById('login-tab').classList.remove('text-gray-500');
                document.getElementById('register-tab').classList.remove('border-blue-500', 'text-blue-700');
                document.getElementById('register-tab').classList.add('text-gray-500');
            });
            document.getElementById('register-tab').addEventListener('click', () => {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
                document.getElementById('register-tab').classList.add('border-blue-500', 'text-blue-700');
                document.getElementById('register-tab').classList.remove('text-gray-500');
                document.getElementById('login-tab').classList.remove('border-blue-500', 'text-blue-700');
                document.getElementById('login-tab').classList.add('text-gray-500');
            });
            document.getElementById('back-to-products').addEventListener('click', () => {
                showSection('products-section');
            });
            document.getElementById('back-to-orders').addEventListener('click', () => {
                showSection('orders-section');
            });
            document.getElementById('checkout-btn').addEventListener('click', () => {
                if (cart.length === 0) {
                    showToast('Your cart is empty', 'error');
                    return;
                }
                showSection('checkout-section');
                
                // Pre-fill checkout form with user data if available
                if (currentUser) {
                    document.getElementById('checkout-name').value = currentUser.name || '';
                    document.getElementById('checkout-email').value = currentUser.email || '';
                    document.getElementById('checkout-phone').value = currentUser.phone || '';
                    document.getElementById('checkout-address').value = currentUser.address || '';
                }
            });
            document.getElementById('browse-products').addEventListener('click', () => {
                showSection('products-section');
                loadProducts();
            });

            // Form submissions
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                login(email, password);
            });
            
            document.getElementById('register-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const userData = {
                    name: document.getElementById('register-name').value,
                    email: document.getElementById('register-email').value,
                    password: document.getElementById('register-password').value,
                    phone: document.getElementById('register-phone').value,
                    address: document.getElementById('register-address').value
                };
                register(userData);
            });
            
            document.getElementById('profile-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const profileData = {
                    name: document.getElementById('profile-name').value,
                    email: document.getElementById('profile-email').value,
                    phone: document.getElementById('profile-phone').value,
                    address: document.getElementById('profile-address').value
                };
                updateProfile(profileData);
            });
            
            document.getElementById('password-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                if (newPassword !== confirmPassword) {
                    showToast('Passwords do not match', 'error');
                    return;
                }
                
                const passwordData = {
                    currentPassword: document.getElementById('current-password').value,
                    newPassword: newPassword
                };
                updatePassword(passwordData);
            });
            
            document.getElementById('checkout-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const orderData = {
                    items: cart.map(item => ({
                        productId: item.id,
                        quantity: item.quantity,
                        price: item.price
                    })),
                    shippingAddress: {
                        name: document.getElementById('checkout-name').value,
                        email: document.getElementById('checkout-email').value,
                        phone: document.getElementById('checkout-phone').value,
                        address: document.getElementById('checkout-address').value
                    },
                    paymentMethod: document.getElementById('checkout-payment').value
                };
                placeOrder(orderData);
            });
        }

        async function loadUserData() {
            await Promise.all([
                loadCart(),
                loadWishlist(),
                loadOrders(),
                loadUserProfile()
            ]);
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
